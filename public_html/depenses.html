<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuditCompta — Analyse Détaillée des Dépenses</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2610/2610269.png">
    <link rel="stylesheet" href="/assets/responsive.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bar-animate { animation: growBar 0.6s ease-out; transform-origin: left; }
        @keyframes growBar { from { transform: scaleX(0); } to { transform: scaleX(1); } }
        .tooltip { position: relative; }
        .tooltip:hover::after {
            content: attr(data-tip);
            position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 4px 8px; border-radius: 6px;
            font-size: 11px; white-space: nowrap; z-index: 50;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-slate-900 px-3 py-1.5 rounded-xl flex items-center justify-center">
                    <span class="font-black text-white text-sm italic tracking-tighter">ATCO</span>
                </div>
                <span class="text-xs font-bold text-slate-400 uppercase tracking-widest hidden sm:block">Analyse Dépenses</span>
            </div>
            <div class="flex items-center gap-2">
                <select id="yearSelect" class="bg-slate-50 border border-slate-200 rounded-xl px-3 py-1.5 text-sm font-bold"></select>
                <select id="yearCompare" class="bg-slate-50 border border-slate-200 rounded-xl px-3 py-1.5 text-sm font-bold">
                    <option value="">Comparer à…</option>
                </select>
                <a href="/" class="bg-slate-100 hover:bg-slate-200 px-3 py-1.5 rounded-xl text-xs font-bold text-slate-600 transition-colors">
                    <i class="fas fa-arrow-left mr-1"></i>Dashboard
                </a>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-6 space-y-6">

        <!-- Loading -->
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="w-12 h-12 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin"></div>
            <p class="mt-4 text-sm text-slate-400 font-bold">Chargement des données…</p>
        </div>

        <!-- Contenu (caché par défaut) -->
        <div id="content" class="hidden space-y-6">

            <!-- SYNTHÈSE -->
            <section class="fade-in">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Charges</p>
                        <p id="totalCharges" class="text-xl font-black text-slate-900 tracking-tight">—</p>
                        <p id="totalChargesVar" class="text-xs font-bold mt-1 hidden"></p>
                    </div>
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Charges Fixes</p>
                        <p id="chargesFixes" class="text-xl font-black text-blue-600 tracking-tight">—</p>
                        <p id="pctFixes" class="text-xs text-slate-400 font-bold"></p>
                    </div>
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Charges Variables</p>
                        <p id="chargesVariables" class="text-xl font-black text-amber-600 tracking-tight">—</p>
                        <p id="pctVariables" class="text-xs text-slate-400 font-bold"></p>
                    </div>
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Fournisseurs</p>
                        <p id="nbFournisseurs" class="text-xl font-black text-slate-900 tracking-tight">—</p>
                        <p id="nbAlerts" class="text-xs text-slate-400 font-bold"></p>
                    </div>
                </div>
            </section>

            <!-- PAR CATÉGORIE PCG -->
            <section class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-slate-100 bg-slate-50/50">
                    <h2 class="font-black text-slate-900 uppercase tracking-tight text-sm">Répartition par catégorie PCG</h2>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="categoriesChart" class="space-y-3"></div>
                </div>
            </section>

            <!-- COMPARAISON ANNÉES (caché si pas de comparaison) -->
            <section id="compareSection" class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hidden">
                <div class="p-4 sm:p-6 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                    <h2 class="font-black text-slate-900 uppercase tracking-tight text-sm">Comparaison année N vs N-1</h2>
                    <span id="compareYearsLabel" class="text-xs font-bold text-slate-400"></span>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="compareChart" class="space-y-3"></div>
                </div>
            </section>

            <!-- ÉVOLUTION MENSUELLE -->
            <section class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-slate-100 bg-slate-50/50">
                    <h2 class="font-black text-slate-900 uppercase tracking-tight text-sm">Évolution mensuelle</h2>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="monthlyChart" class="h-[220px] w-full"></div>
                </div>
            </section>

            <!-- DÉTAIL PAR COMPTE -->
            <section class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between flex-wrap gap-2">
                    <h2 class="font-black text-slate-900 uppercase tracking-tight text-sm">Détail par compte</h2>
                    <input id="searchCompte" type="text" placeholder="Rechercher…"
                        class="bg-slate-50 border border-slate-200 rounded-xl px-3 py-1.5 text-xs w-40 outline-none focus:border-blue-600">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200">
                                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-wider">Compte</th>
                                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-wider">Libellé</th>
                                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-wider text-right">Montant</th>
                                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-wider text-right">%</th>
                                <th class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-wider text-right hidden sm:table-cell">Écritures</th>
                                <th id="compteVarHeader" class="px-4 py-3 text-[10px] font-black text-slate-400 uppercase tracking-wider text-right hidden">Var N-1</th>
                            </tr>
                        </thead>
                        <tbody id="comptesBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </section>

            <!-- TOP FOURNISSEURS -->
            <section class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-4 sm:p-6 border-b border-slate-100 bg-slate-50/50">
                    <h2 class="font-black text-slate-900 uppercase tracking-tight text-sm">Top Fournisseurs</h2>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="fournisseursChart" class="space-y-3"></div>
                </div>
            </section>

            <!-- ALERTES -->
            <section id="alertsSection" class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hidden">
                <div class="p-4 sm:p-6 border-b border-slate-100 bg-red-50/50">
                    <h2 class="font-black text-red-600 uppercase tracking-tight text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>Alertes</h2>
                </div>
                <div class="p-4 sm:p-6 space-y-4">
                    <div id="alertsContent"></div>
                </div>
            </section>

        </div>
    </main>

    <script>
    // ═══════════════════════════════════════
    // ANALYSE DÉTAILLÉE DES DÉPENSES
    // ═══════════════════════════════════════

    const API_BASE = '/api/v1';
    const EUR = v => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v || 0);
    const PCT = v => (v || 0).toFixed(1) + '%';
    const COLORS = ['#3b82f6','#f59e0b','#ef4444','#10b981','#8b5cf6','#ec4899','#06b6d4','#f97316','#84cc16'];
    const MONTHS_FR = ['Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'];

    let currentData = null;
    let compareData = null;

    // ── Init ──
    async function init() {
        const yearsResp = await fetch(`${API_BASE}/years/list.php`);
        const yearsJson = await yearsResp.json();
        const years = yearsJson.data || [];

        const sel = document.getElementById('yearSelect');
        const cmp = document.getElementById('yearCompare');
        years.forEach(y => {
            sel.add(new Option(y, y));
            cmp.add(new Option(y, y));
        });
        if (years.length > 1) cmp.value = years[1];

        sel.addEventListener('change', () => loadData());
        cmp.addEventListener('change', () => loadData());

        await loadData();
    }

    async function loadData() {
        const year = document.getElementById('yearSelect').value;
        const compareYear = document.getElementById('yearCompare').value;

        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('content').classList.add('hidden');

        try {
            const [expResp, sigResp] = await Promise.all([
                fetch(`${API_BASE}/expenses/deep-dive.php?exercice=${year}`),
                fetch(`${API_BASE}/sig/simple.php?exercice=${year}`)
            ]);
            const expJson = await expResp.json();
            const sigJson = await sigResp.json();
            currentData = { ...expJson.data, sig: sigJson.data };

            if (compareYear && compareYear !== year) {
                const [cExpResp, cSigResp] = await Promise.all([
                    fetch(`${API_BASE}/expenses/deep-dive.php?exercice=${compareYear}`),
                    fetch(`${API_BASE}/sig/simple.php?exercice=${compareYear}`)
                ]);
                const cExpJson = await cExpResp.json();
                const cSigJson = await cSigResp.json();
                compareData = { ...cExpJson.data, sig: cSigJson.data };
            } else {
                compareData = null;
            }

            render();
        } catch (e) {
            console.error('Erreur chargement:', e);
        }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
    }

    // ── Render ──
    function render() {
        const d = currentData;
        const c = compareData;
        const s = d.synthese;

        // Synthèse
        document.getElementById('totalCharges').textContent = EUR(s.total_charges);
        document.getElementById('chargesFixes').textContent = EUR(s.charges_fixes);
        document.getElementById('chargesVariables').textContent = EUR(s.charges_variables);
        document.getElementById('pctFixes').textContent = PCT(s.pct_fixes) + ' du total';
        document.getElementById('pctVariables').textContent = PCT(s.pct_variables) + ' du total';
        document.getElementById('nbFournisseurs').textContent = s.nb_fournisseurs;

        const alertCount = s.nb_doublons_detectes + s.nb_variations_atypiques;
        document.getElementById('nbAlerts').textContent = alertCount > 0 ? `${alertCount} alertes` : 'Aucune alerte';

        // Variation vs N-1
        if (c) {
            const varPct = ((s.total_charges - c.synthese.total_charges) / (c.synthese.total_charges || 1) * 100);
            const el = document.getElementById('totalChargesVar');
            el.textContent = (varPct >= 0 ? '+' : '') + varPct.toFixed(1) + '% vs N-1';
            el.className = `text-xs font-bold mt-1 ${varPct > 5 ? 'text-red-500' : varPct < -5 ? 'text-green-500' : 'text-slate-400'}`;
            el.classList.remove('hidden');
        }

        renderCategories(d.par_categorie, c?.par_categorie);
        renderCompare(d, c);
        renderMonthly(d.evolution_mensuelle, c?.evolution_mensuelle);
        renderComptes(d.par_compte, c?.par_compte);
        renderFournisseurs(d.par_fournisseur);
        renderAlerts(d);
    }

    // ── Catégories PCG (barres horizontales) ──
    function renderCategories(cats, cmpCats) {
        const container = document.getElementById('categoriesChart');
        const max = Math.max(...cats.map(c => c.montant), 1);
        container.innerHTML = cats.map((cat, i) => {
            const cmpCat = cmpCats?.find(c => c.code === cat.code);
            const varHtml = cmpCat
                ? (() => { const v = ((cat.montant - cmpCat.montant) / (cmpCat.montant || 1) * 100); return `<span class="${v > 5 ? 'text-red-500' : v < -5 ? 'text-green-500' : 'text-slate-400'} text-xs font-bold ml-2">${v >= 0 ? '+' : ''}${v.toFixed(1)}%</span>`; })()
                : '';
            return `
            <div class="flex items-center gap-3">
                <div class="w-32 sm:w-48 shrink-0">
                    <p class="text-xs font-bold text-slate-700 truncate">${cat.label}</p>
                    <p class="text-[10px] text-slate-400">Classe ${cat.code}</p>
                </div>
                <div class="flex-1 flex items-center gap-2">
                    <div class="flex-1 bg-slate-100 rounded-full h-5 overflow-hidden">
                        <div class="h-full rounded-full bar-animate" style="width:${(cat.montant/max*100).toFixed(1)}%;background:${COLORS[i%COLORS.length]}"></div>
                    </div>
                    <span class="text-xs font-black text-slate-900 w-20 text-right shrink-0">${EUR(cat.montant)}</span>
                    <span class="text-[10px] text-slate-400 w-10 text-right shrink-0">${PCT(cat.pct_total)}</span>
                    ${varHtml}
                </div>
            </div>`;
        }).join('');
    }

    // ── Comparaison N vs N-1 ──
    function renderCompare(d, c) {
        const section = document.getElementById('compareSection');
        if (!c) { section.classList.add('hidden'); return; }
        section.classList.remove('hidden');

        document.getElementById('compareYearsLabel').textContent = `${d.exercice} vs ${c.exercice}`;
        document.getElementById('compteVarHeader').classList.remove('hidden');

        const allCodes = new Set([...d.par_categorie.map(x=>x.code), ...c.par_categorie.map(x=>x.code)]);
        const rows = [...allCodes].sort().map(code => {
            const curr = d.par_categorie.find(x => x.code === code) || { label: code, montant: 0 };
            const prev = c.par_categorie.find(x => x.code === code) || { montant: 0 };
            const diff = curr.montant - prev.montant;
            const pct = prev.montant ? (diff / prev.montant * 100) : (curr.montant ? 100 : 0);
            return { code, label: curr.label || prev.label || `Classe ${code}`, curr: curr.montant, prev: prev.montant, diff, pct };
        });

        const maxVal = Math.max(...rows.map(r => Math.max(r.curr, r.prev)), 1);
        const container = document.getElementById('compareChart');
        container.innerHTML = rows.map(r => `
            <div class="space-y-1">
                <div class="flex justify-between items-center">
                    <span class="text-xs font-bold text-slate-700">${r.label}</span>
                    <span class="text-xs font-bold ${r.pct > 5 ? 'text-red-500' : r.pct < -5 ? 'text-green-500' : 'text-slate-400'}">
                        ${r.pct >= 0 ? '+' : ''}${r.pct.toFixed(1)}%
                    </span>
                </div>
                <div class="flex items-center gap-2 text-[10px]">
                    <span class="w-8 text-right text-blue-600 font-bold">${d.exercice}</span>
                    <div class="flex-1 bg-slate-100 rounded-full h-3 overflow-hidden">
                        <div class="h-full bg-blue-500 rounded-full" style="width:${(r.curr/maxVal*100).toFixed(1)}%"></div>
                    </div>
                    <span class="w-16 text-right font-bold text-slate-700">${EUR(r.curr)}</span>
                </div>
                <div class="flex items-center gap-2 text-[10px]">
                    <span class="w-8 text-right text-slate-400 font-bold">${c.exercice}</span>
                    <div class="flex-1 bg-slate-100 rounded-full h-3 overflow-hidden">
                        <div class="h-full bg-slate-300 rounded-full" style="width:${(r.prev/maxVal*100).toFixed(1)}%"></div>
                    </div>
                    <span class="w-16 text-right font-bold text-slate-400">${EUR(r.prev)}</span>
                </div>
            </div>
        `).join('');
    }

    // ── Évolution mensuelle (canvas) ──
    function renderMonthly(months, cmpMonths) {
        const container = document.getElementById('monthlyChart');
        if (!months.length) {
            container.innerHTML = '<p class="text-sm text-slate-400 text-center py-8">Aucune donnée mensuelle</p>';
            return;
        }

        // Construire 12 mois
        const year = currentData.exercice;
        const data = Array.from({ length: 12 }, (_, i) => {
            const key = `${year}-${String(i + 1).padStart(2, '0')}`;
            const found = months.find(m => m.mois === key);
            return { month: MONTHS_FR[i], value: found?.total || 0 };
        });

        let cmpData = null;
        if (cmpMonths?.length) {
            const cYear = compareData.exercice;
            cmpData = Array.from({ length: 12 }, (_, i) => {
                const key = `${cYear}-${String(i + 1).padStart(2, '0')}`;
                const found = cmpMonths.find(m => m.mois === key);
                return { month: MONTHS_FR[i], value: found?.total || 0 };
            });
        }

        const maxVal = Math.max(...data.map(d => d.value), ...(cmpData?.map(d => d.value) || [0]), 1);

        container.innerHTML = `
            <div class="flex items-end justify-between gap-1 h-full px-1" style="min-height:180px">
                ${data.map((d, i) => {
                    const h = (d.value / maxVal * 150);
                    const ch = cmpData ? (cmpData[i].value / maxVal * 150) : 0;
                    return `
                    <div class="flex-1 flex flex-col items-center justify-end gap-1 h-full">
                        ${d.value > 0 ? `<span class="text-[8px] font-bold text-slate-500 truncate">${EUR(d.value)}</span>` : ''}
                        <div class="flex items-end gap-px w-full justify-center" style="height:160px">
                            ${cmpData ? `<div class="bg-slate-200 rounded-t w-1/3 transition-all" style="height:${ch}px" title="${compareData.exercice}: ${EUR(cmpData[i].value)}"></div>` : ''}
                            <div class="bg-blue-500 rounded-t ${cmpData ? 'w-1/3' : 'w-2/3'} transition-all" style="height:${h}px" title="${currentData.exercice}: ${EUR(d.value)}"></div>
                        </div>
                        <span class="text-[9px] font-bold text-slate-400">${d.month}</span>
                    </div>`;
                }).join('')}
            </div>
            ${cmpData ? `
            <div class="flex justify-center gap-4 mt-3 text-[10px] font-bold">
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-blue-500 inline-block"></span>${currentData.exercice}</span>
                <span class="flex items-center gap-1"><span class="w-3 h-3 rounded bg-slate-200 inline-block"></span>${compareData.exercice}</span>
            </div>` : ''}
        `;
    }

    // ── Détail par compte ──
    function renderComptes(comptes, cmpComptes) {
        const tbody = document.getElementById('comptesBody');
        tbody.innerHTML = comptes.map(c => {
            const cmpC = cmpComptes?.find(x => x.compte_num === c.compte_num);
            let varHtml = '';
            if (cmpC) {
                const v = ((c.montant - cmpC.montant) / (cmpC.montant || 1) * 100);
                varHtml = `<td class="px-4 py-3 text-right text-xs font-bold ${v > 10 ? 'text-red-500' : v < -10 ? 'text-green-500' : 'text-slate-400'}">
                    ${v >= 0 ? '+' : ''}${v.toFixed(1)}%
                </td>`;
            } else if (compareData) {
                varHtml = '<td class="px-4 py-3 text-right text-xs text-slate-300">—</td>';
            }
            return `
            <tr class="hover:bg-slate-50 transition-colors compte-row" data-search="${c.compte_num} ${(c.compte_lib||'').toLowerCase()}">
                <td class="px-4 py-3 text-xs font-mono font-bold text-blue-600">${c.compte_num}</td>
                <td class="px-4 py-3 text-xs font-bold text-slate-700">${c.compte_lib || '—'}</td>
                <td class="px-4 py-3 text-right text-xs font-black text-slate-900">${EUR(c.montant)}</td>
                <td class="px-4 py-3 text-right text-xs font-bold text-slate-400">${PCT(c.pct_total)}</td>
                <td class="px-4 py-3 text-right text-xs text-slate-500 hidden sm:table-cell">${c.nb_ecritures}</td>
                ${varHtml}
            </tr>`;
        }).join('');

        // Recherche
        document.getElementById('searchCompte').oninput = (e) => {
            const q = e.target.value.toLowerCase();
            document.querySelectorAll('.compte-row').forEach(row => {
                row.style.display = row.dataset.search.includes(q) ? '' : 'none';
            });
        };
    }

    // ── Top Fournisseurs ──
    function renderFournisseurs(fournisseurs) {
        const container = document.getElementById('fournisseursChart');
        if (!fournisseurs.length) {
            container.innerHTML = '<p class="text-sm text-slate-400 text-center py-4">Aucun fournisseur identifié</p>';
            return;
        }
        const max = Math.max(...fournisseurs.map(f => f.montant), 1);
        const top = fournisseurs.slice(0, 10);
        container.innerHTML = top.map((f, i) => `
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg bg-slate-100 flex items-center justify-center text-xs font-black text-slate-500 shrink-0">${i + 1}</div>
                <div class="flex-1 min-w-0">
                    <p class="text-xs font-bold text-slate-700 truncate">${f.nom || 'Non identifié'}</p>
                    <p class="text-[10px] text-slate-400">${f.nb_factures} facture${f.nb_factures > 1 ? 's' : ''}</p>
                </div>
                <div class="w-24 sm:w-40 bg-slate-100 rounded-full h-4 overflow-hidden shrink-0">
                    <div class="h-full bg-blue-500 rounded-full bar-animate" style="width:${(f.montant/max*100).toFixed(1)}%"></div>
                </div>
                <span class="text-xs font-black text-slate-900 w-20 text-right shrink-0">${EUR(f.montant)}</span>
                <span class="text-[10px] text-slate-400 w-10 text-right shrink-0">${PCT(f.pct_total)}</span>
            </div>
        `).join('');
    }

    // ── Alertes ──
    function renderAlerts(d) {
        const section = document.getElementById('alertsSection');
        const content = document.getElementById('alertsContent');
        const alerts = [];

        if (d.doublons_factures?.length) {
            alerts.push(...d.doublons_factures.map(f =>
                `<div class="flex items-start gap-3 p-3 bg-red-50 rounded-xl">
                    <i class="fas fa-copy text-red-400 mt-0.5"></i>
                    <div>
                        <p class="text-xs font-bold text-red-700">Doublon détecté</p>
                        <p class="text-[10px] text-red-500">Fournisseur ${f.fournisseur || '?'} · ${EUR(f.montant)} · ${f.nb_occurrences}x</p>
                    </div>
                </div>`
            ));
        }

        if (d.variations_atypiques?.length) {
            alerts.push(...d.variations_atypiques.map(v =>
                `<div class="flex items-start gap-3 p-3 bg-amber-50 rounded-xl">
                    <i class="fas fa-chart-line text-amber-400 mt-0.5"></i>
                    <div>
                        <p class="text-xs font-bold text-amber-700">Variation atypique</p>
                        <p class="text-[10px] text-amber-500">${v.label || v.compte} · ${v.variation_pct > 0 ? '+' : ''}${v.variation_pct?.toFixed(1)}%</p>
                    </div>
                </div>`
            ));
        }

        if (alerts.length) {
            section.classList.remove('hidden');
            content.innerHTML = alerts.join('');
        } else {
            section.classList.add('hidden');
        }
    }

    // ── Boot ──
    init().catch(e => {
        document.getElementById('loading').innerHTML = `<p class="text-red-500 text-sm">Erreur: ${e.message}</p>`;
    });
    </script>
</body>
</html>