<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuditCompta — Analyse Détaillée des Dépenses</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'] } } }
      }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2610/2610269.png">
    <link rel="stylesheet" href="/assets/responsive.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .bar-animate { animation: growBar 0.6s ease-out; transform-origin: left; }
        @keyframes growBar { from { transform: scaleX(0); } to { transform: scaleX(1); } }
        .sort-btn { cursor: pointer; user-select: none; }
        .sort-btn:hover { color: #3b82f6; }
        .sort-btn.active { color: #3b82f6; }
        tr.line-row:hover { background: #f8fafc; }
        .page-btn { min-width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center; }
        .page-btn.active { background: #1e293b; color: white; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- HEADER -->
    <header class="bg-white border-b border-slate-200 sticky top-0 z-20 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <a href="/" class="bg-slate-900 px-3 py-1.5 rounded-xl flex items-center justify-center hover:bg-blue-600 transition-colors">
                    <span class="font-black text-white text-sm italic tracking-tighter">ATCO</span>
                </a>
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest hidden sm:block">Analyse Dépenses</span>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
                <select id="yearSelect" class="bg-slate-50 border border-slate-200 rounded-xl px-3 py-1.5 text-xs font-bold focus:border-blue-500 outline-none"></select>
                <select id="yearCompare" class="bg-slate-50 border border-slate-200 rounded-xl px-3 py-1.5 text-xs font-bold focus:border-blue-500 outline-none">
                    <option value="">Comparer…</option>
                </select>
                <button onclick="showImportModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-xl text-[11px] font-bold transition-colors">
                    <i class="fas fa-file-import mr-1"></i>Importer FEC
                </button>
                <a href="/" class="bg-slate-100 hover:bg-slate-200 px-3 py-1.5 rounded-xl text-[11px] font-bold text-slate-600 transition-colors">
                    <i class="fas fa-arrow-left mr-1"></i>Dashboard
                </a>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-5 space-y-5">

        <!-- Loading -->
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="w-12 h-12 border-4 border-slate-200 border-t-blue-600 rounded-full animate-spin"></div>
            <p class="mt-4 text-sm text-slate-400 font-bold">Chargement des données…</p>
        </div>

        <!-- Contenu -->
        <div id="content" class="hidden space-y-5">

            <!-- SYNTHÈSE KPI -->
            <section class="fade-in">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Total Charges</p>
                        <p id="totalCharges" class="text-xl font-black text-slate-900 tracking-tight">—</p>
                        <p id="totalChargesVar" class="text-[10px] font-bold mt-0.5 hidden"></p>
                    </div>
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Charges Fixes</p>
                        <p id="chargesFixes" class="text-xl font-black text-blue-600 tracking-tight">—</p>
                        <p id="pctFixes" class="text-[10px] text-slate-400 font-bold"></p>
                    </div>
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Charges Variables</p>
                        <p id="chargesVariables" class="text-xl font-black text-amber-600 tracking-tight">—</p>
                        <p id="pctVariables" class="text-[10px] text-slate-400 font-bold"></p>
                    </div>
                    <div class="bg-white rounded-2xl border border-slate-200 p-4 shadow-sm">
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Fournisseurs</p>
                        <p id="nbFournisseurs" class="text-xl font-black text-slate-900 tracking-tight">—</p>
                        <p id="nbAlerts" class="text-[10px] text-slate-400 font-bold"></p>
                    </div>
                </div>
            </section>

            <!-- PAR CATÉGORIE PCG -->
            <section class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50">
                    <h2 class="font-black text-slate-900 uppercase tracking-tight text-xs">Répartition par catégorie PCG</h2>
                </div>
                <div class="p-4">
                    <div id="categoriesChart" class="space-y-2"></div>
                </div>
            </section>

            <!-- COMPARAISON -->
            <section id="compareSection" class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex items-center justify-between">
                    <h2 class="font-black text-slate-900 uppercase tracking-tight text-xs">Comparaison N vs N-1</h2>
                    <span id="compareYearsLabel" class="text-[10px] font-bold text-slate-400"></span>
                </div>
                <div class="p-4">
                    <div id="compareChart" class="space-y-3"></div>
                </div>
            </section>

            <!-- ÉVOLUTION MENSUELLE -->
            <section class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50">
                    <h2 class="font-black text-slate-900 uppercase tracking-tight text-xs">Évolution mensuelle</h2>
                </div>
                <div class="p-4">
                    <div id="monthlyChart" class="h-[200px] w-full"></div>
                </div>
            </section>

            <!-- TOP FOURNISSEURS -->
            <section class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50">
                    <h2 class="font-black text-slate-900 uppercase tracking-tight text-xs">Top Fournisseurs</h2>
                </div>
                <div class="p-4">
                    <div id="fournisseursChart" class="space-y-2"></div>
                </div>
            </section>

            <!-- FRAIS BANCAIRES -->
            <section id="bankFeesSection" class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hidden">
                <div class="p-4 border-b border-slate-100 bg-orange-50/50 flex items-center justify-between">
                    <div>
                        <h2 class="font-black text-slate-900 uppercase tracking-tight text-xs"><i class="fas fa-university mr-1.5 text-orange-500"></i>Frais Bancaires</h2>
                        <p id="bankFeesSubtitle" class="text-[10px] text-slate-400 font-bold mt-0.5"></p>
                    </div>
                    <button onclick="showBankFeesDetail()" class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-1.5 rounded-xl text-[10px] font-bold transition-colors"><i class="fas fa-search-plus mr-1"></i>Détail complet</button>
                </div>
                <div class="p-4">
                    <div id="bankFeesKPI" class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4"></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Répartition par type</h3>
                            <div id="bankFeesPie" class="flex items-center gap-4 justify-center" style="min-height:200px"></div>
                        </div>
                        <div>
                            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Par banque / journal</h3>
                            <div id="bankFeesBar" class="space-y-2"></div>
                        </div>
                    </div>
                    <div id="bankFeesArreteSection" class="mt-4 hidden">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">
                            <span class="inline-flex items-center gap-1">
                                <svg class="w-3 h-3 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/></svg>
                                Arrêtés de compte (intérêts trimestriels / agios)
                            </span>
                        </h3>
                        <div id="bankFeesArreteDetail" class="space-y-1"></div>
                    </div>
                    <div class="mt-4">
                        <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Évolution mensuelle des frais bancaires</h3>
                        <div id="bankFeesMonthly" class="h-[160px] w-full"></div>
                    </div>
                </div>
            </section>

            <!-- ═══════════════════════════════════════ -->
            <!-- DÉTAIL COMPLET — TOUTES LES LIGNES     -->
            <!-- ═══════════════════════════════════════ -->
            <section class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50">
                    <div class="flex items-center justify-between flex-wrap gap-2">
                        <div>
                            <h2 class="font-black text-slate-900 uppercase tracking-tight text-xs">
                                <i class="fas fa-list-ul mr-1.5 text-blue-500"></i>Toutes les écritures de charges
                            </h2>
                            <p id="linesCount" class="text-[10px] text-slate-400 font-bold mt-0.5"></p>
                        </div>
                        <div class="flex items-center gap-2 flex-wrap">
                            <select id="filterJournal" class="bg-white border border-slate-200 rounded-lg px-2 py-1 text-[11px] font-bold outline-none focus:border-blue-500">
                                <option value="">Tous journaux</option>
                            </select>
                            <select id="filterCompte" class="bg-white border border-slate-200 rounded-lg px-2 py-1 text-[11px] font-bold outline-none focus:border-blue-500">
                                <option value="">Tous comptes</option>
                            </select>
                            <div class="relative">
                                <input id="searchLines" type="text" placeholder="Rechercher…"
                                    class="bg-white border border-slate-200 rounded-lg pl-7 pr-2 py-1 text-[11px] w-36 outline-none focus:border-blue-500">
                                <i class="fas fa-search absolute left-2 top-1/2 -translate-y-1/2 text-slate-300 text-[10px]"></i>
                            </div>
                            <button id="exportCsv" class="bg-slate-900 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-[11px] font-bold transition-colors">
                                <i class="fas fa-download mr-1"></i>CSV
                            </button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left" id="linesTable">
                        <thead>
                            <tr class="bg-slate-50 border-b border-slate-200">
                                <th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-wider sort-btn cursor-pointer hover:text-blue-500 select-none" data-sort="date">
                                    Date <i class="fas fa-sort ml-0.5 text-slate-300"></i>
                                </th>
                                <th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-wider sort-btn cursor-pointer hover:text-blue-500 select-none" data-sort="journal">
                                    Jrnl <i class="fas fa-sort ml-0.5 text-slate-300"></i>
                                </th>
                                <th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-wider sort-btn cursor-pointer hover:text-blue-500 select-none" data-sort="compte">
                                    Compte <i class="fas fa-sort ml-0.5 text-slate-300"></i>
                                </th>
                                <th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-wider hidden md:table-cell sort-btn cursor-pointer hover:text-blue-500 select-none" data-sort="compte_lib">
                                    Lib. compte <i class="fas fa-sort ml-0.5 text-slate-300"></i>
                                </th>
                                <th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-wider sort-btn cursor-pointer hover:text-blue-500 select-none" data-sort="piece">
                                    Pièce <i class="fas fa-sort ml-0.5 text-slate-300"></i>
                                </th>
                                <th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-wider sort-btn cursor-pointer hover:text-blue-500 select-none" data-sort="libelle">
                                    Libellé écriture <i class="fas fa-sort ml-0.5 text-slate-300"></i>
                                </th>
                                <th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-wider text-right sort-btn cursor-pointer hover:text-blue-500 select-none" data-sort="debit">
                                    Débit <i class="fas fa-sort ml-0.5 text-slate-300"></i>
                                </th>
                                <th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-wider text-right sort-btn cursor-pointer hover:text-blue-500 select-none" data-sort="credit">
                                    Crédit <i class="fas fa-sort ml-0.5 text-slate-300"></i>
                                </th>
                                <th class="px-3 py-2.5 text-[9px] font-black text-slate-400 uppercase tracking-wider text-right sort-btn cursor-pointer hover:text-blue-500 select-none" data-sort="montant">
                                    Solde <i class="fas fa-sort ml-0.5 text-slate-300"></i>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="linesBody" class="divide-y divide-slate-50"></tbody>
                        <tfoot>
                            <tr class="bg-slate-50 border-t-2 border-slate-200">
                                <td colspan="6" class="px-3 py-2.5 text-[10px] font-black text-slate-600 uppercase">Total filtré</td>
                                <td id="totalDebit" class="px-3 py-2.5 text-right text-[11px] font-black text-slate-900"></td>
                                <td id="totalCredit" class="px-3 py-2.5 text-right text-[11px] font-black text-slate-900"></td>
                                <td id="totalSolde" class="px-3 py-2.5 text-right text-[11px] font-black text-blue-600"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <!-- Pagination -->
                <div class="p-4 border-t border-slate-100 flex items-center justify-between flex-wrap gap-2">
                    <p id="paginationInfo" class="text-[10px] text-slate-400 font-bold"></p>
                    <div id="paginationBtns" class="flex gap-1"></div>
                </div>
            </section>

            <!-- ALERTES -->
            <section id="alertsSection" class="fade-in bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden hidden">
                <div class="p-4 border-b border-slate-100 bg-red-50/50">
                    <h2 class="font-black text-red-600 uppercase tracking-tight text-xs"><i class="fas fa-exclamation-triangle mr-2"></i>Alertes</h2>
                </div>
                <div class="p-4 space-y-3">
                    <div id="alertsContent"></div>
                </div>
            </section>

        </div>
    </main>

    <!-- MODAL DÉTAIL CATÉGORIE -->
    <div id="detailModal" class="fixed inset-0 z-50 hidden" onclick="if(event.target===this)closeDetailModal()">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div class="relative mx-auto mt-8 mb-8 bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden" style="max-width:900px;max-height:calc(100vh - 4rem);display:flex;flex-direction:column">
            <div class="p-5 border-b border-slate-200 bg-gradient-to-r from-blue-50 to-white flex items-center justify-between">
                <div>
                    <h2 id="detailTitle" class="font-black text-slate-900 text-sm"><i class="fas fa-search-plus mr-1.5 text-blue-500"></i>Détail</h2>
                    <p id="detailSubtitle" class="text-[10px] text-slate-400 font-bold mt-0.5"></p>
                </div>
                <button onclick="closeDetailModal()" class="w-8 h-8 rounded-full bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-colors"><i class="fas fa-times text-slate-500"></i></button>
            </div>
            <div class="flex-1 overflow-auto p-5">
                <div id="detailLoading" class="text-center py-12"><div class="w-8 h-8 border-3 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-2"></div><p class="text-sm text-slate-500 font-bold">Chargement…</p></div>
                <div id="detailContent" class="hidden">
                    <div id="detailNote" class="hidden mb-4 bg-amber-50 border border-amber-200 rounded-xl p-3 text-[11px] text-amber-700 font-bold"><i class="fas fa-info-circle mr-1"></i><span id="detailNoteText"></span></div>
                    <div id="detailStats" class="grid grid-cols-3 gap-3 mb-4"></div>
                    <!-- Filtres modal détail -->
                    <div class="flex items-center gap-2 flex-wrap mb-3">
                        <div class="relative flex-1 min-w-[180px]">
                            <i class="fas fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-300 text-xs"></i>
                            <input id="detailSearch" type="text" placeholder="Rechercher (libellé, compte, tiers…)" class="w-full bg-white border border-slate-200 rounded-lg pl-8 pr-3 py-1.5 text-[11px] font-bold outline-none focus:border-blue-500 transition-colors">
                        </div>
                        <select id="detailSousCompte" class="bg-white border border-slate-200 rounded-lg px-2 py-1.5 text-[11px] font-bold outline-none focus:border-blue-500">
                            <option value="">Tous sous-comptes</option>
                        </select>
                        <select id="detailSort" class="bg-white border border-slate-200 rounded-lg px-2 py-1.5 text-[11px] font-bold outline-none focus:border-blue-500">
                            <option value="montant-desc">Montant ↓</option>
                            <option value="montant-asc">Montant ↑</option>
                            <option value="date-desc">Date ↓</option>
                            <option value="date-asc">Date ↑</option>
                            <option value="libelle-asc">Libellé A→Z</option>
                            <option value="libelle-desc">Libellé Z→A</option>
                            <option value="compte-asc">Compte ↑</option>
                        </select>
                    </div>
                    <div class="overflow-x-auto rounded-xl border border-slate-200">
                        <table class="w-full text-left">
                            <thead><tr class="bg-slate-50 text-[9px] font-black text-slate-400 uppercase tracking-wider">
                                <th class="px-3 py-2 cursor-pointer hover:text-blue-500" onclick="detailSortBy('date')">Date <i id="dsort-date" class="fas fa-sort ml-0.5 text-slate-300"></i></th><th class="px-3 py-2">Journal</th><th class="px-3 py-2 cursor-pointer hover:text-blue-500" onclick="detailSortBy('compte')">Compte <i id="dsort-compte" class="fas fa-sort ml-0.5 text-slate-300"></i></th><th class="px-3 py-2 cursor-pointer hover:text-blue-500" onclick="detailSortBy('libelle')">Libellé <i id="dsort-libelle" class="fas fa-sort ml-0.5 text-slate-300"></i></th><th class="px-3 py-2">Pièce</th><th class="px-3 py-2 text-right cursor-pointer hover:text-blue-500" onclick="detailSortBy('debit')">Débit <i id="dsort-debit" class="fas fa-sort ml-0.5 text-slate-300"></i></th><th class="px-3 py-2 text-right cursor-pointer hover:text-blue-500" onclick="detailSortBy('credit')">Crédit <i id="dsort-credit" class="fas fa-sort ml-0.5 text-slate-300"></i></th><th class="px-3 py-2 text-right cursor-pointer hover:text-blue-500" onclick="detailSortBy('montant')">Montant <i id="dsort-montant" class="fas fa-sort ml-0.5 text-slate-300"></i></th>
                            </tr></thead>
                            <tbody id="detailBody"></tbody>
                            <tfoot><tr class="bg-slate-50 border-t-2 border-slate-300"><td colspan="5" class="px-3 py-2 text-[11px] font-black text-slate-700">TOTAL</td><td id="detailTotalDebit" class="px-3 py-2 text-right text-[11px] font-black"></td><td id="detailTotalCredit" class="px-3 py-2 text-right text-[11px] font-black"></td><td id="detailTotalMontant" class="px-3 py-2 text-right text-[11px] font-black"></td></tr></tfoot>
                        </table>
                    </div>
                    <div id="detailPagination" class="flex items-center justify-between mt-3">
                        <span id="detailPagInfo" class="text-[10px] text-slate-400 font-bold"></span>
                        <div id="detailPagBtns" class="flex gap-1"></div>
                    </div>
                    <!-- Contreparties (ex: détail par salarié pour classe 64) -->
                    <div id="counterpartSection" class="hidden mt-6">
                        <div class="flex items-center justify-between mb-3">
                            <h3 id="counterpartTitle" class="font-black text-slate-900 text-xs"><i class="fas fa-users mr-1.5 text-green-500"></i>Détail par salarié</h3>
                            <div class="relative">
                                <i class="fas fa-search absolute left-2.5 top-1/2 -translate-y-1/2 text-slate-300 text-xs"></i>
                                <input id="counterpartSearch" type="text" placeholder="Rechercher un nom…" class="bg-white border border-slate-200 rounded-lg pl-8 pr-3 py-1.5 text-[11px] font-bold outline-none focus:border-blue-500 w-56">
                            </div>
                        </div>
                        <div class="overflow-x-auto rounded-xl border border-slate-200">
                            <table class="w-full text-left">
                                <thead><tr class="bg-green-50 text-[9px] font-black text-slate-400 uppercase tracking-wider">
                                    <th class="px-3 py-2">Date</th><th class="px-3 py-2">Compte</th><th class="px-3 py-2">Nom</th><th class="px-3 py-2">Libellé</th><th class="px-3 py-2 text-right">Montant</th>
                                </tr></thead>
                                <tbody id="counterpartBody"></tbody>
                                <tfoot><tr class="bg-green-50 border-t-2 border-green-300"><td colspan="4" class="px-3 py-2 text-[11px] font-black text-green-700">TOTAL</td><td id="counterpartTotal" class="px-3 py-2 text-right text-[11px] font-black text-green-700"></td></tr></tfoot>
                            </table>
                        </div>
                        <div id="counterpartPagination" class="flex items-center justify-between mt-3">
                            <span id="counterpartPagInfo" class="text-[10px] text-slate-400 font-bold"></span>
                            <div id="counterpartPagBtns" class="flex gap-1"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL IMPORT FEC -->
    <div id="importModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="closeImportModal()"></div>
        <div class="absolute inset-4 sm:inset-auto sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 sm:w-[600px] sm:max-h-[80vh] bg-white rounded-2xl shadow-2xl flex flex-col overflow-hidden">
            <div class="p-5 border-b border-slate-200 flex items-center justify-between">
                <h3 class="font-black text-slate-900 text-sm"><i class="fas fa-file-import mr-2 text-blue-500"></i>Importer un fichier FEC</h3>
                <button onclick="closeImportModal()" class="w-8 h-8 rounded-lg bg-slate-100 hover:bg-slate-200 flex items-center justify-center text-slate-400 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 flex-1 overflow-y-auto space-y-4">
                <div id="importDropZone" class="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50/50 transition-all">
                    <i class="fas fa-cloud-upload-alt text-3xl text-slate-300 mb-3"></i>
                    <p class="text-sm font-bold text-slate-600">Glissez votre fichier FEC ici</p>
                    <p class="text-[11px] text-slate-400 mt-1">ou cliquez pour parcourir (.txt, .csv)</p>
                    <input type="file" id="fecFileInput" accept=".txt,.csv,.TXT,.CSV" class="hidden">
                </div>
                <div id="importPreview" class="hidden space-y-3">
                    <div class="bg-slate-50 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-[11px] font-black text-slate-500 uppercase">Aperçu du fichier</span>
                            <span id="importFileName" class="text-[11px] font-bold text-blue-600"></span>
                        </div>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-white rounded-lg p-3 border border-slate-200 text-center">
                                <p id="importTotalLines" class="text-lg font-black text-slate-900">0</p>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">Lignes totales</p>
                            </div>
                            <div class="bg-white rounded-lg p-3 border border-slate-200 text-center">
                                <p id="importChargesLines" class="text-lg font-black text-blue-600">0</p>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">Charges (cl.6)</p>
                            </div>
                            <div class="bg-white rounded-lg p-3 border border-slate-200 text-center">
                                <p id="importExercice" class="text-lg font-black text-amber-600">—</p>
                                <p class="text-[9px] font-bold text-slate-400 uppercase">Exercice</p>
                            </div>
                        </div>
                    </div>
                    <div id="importSampleTable" class="overflow-x-auto rounded-xl border border-slate-200">
                        <table class="w-full text-left text-[10px]">
                            <thead><tr class="bg-slate-50"><th class="px-2 py-1.5 font-black text-slate-400">Journal</th><th class="px-2 py-1.5 font-black text-slate-400">Date</th><th class="px-2 py-1.5 font-black text-slate-400">Compte</th><th class="px-2 py-1.5 font-black text-slate-400">Libellé</th><th class="px-2 py-1.5 font-black text-slate-400 text-right">Débit</th><th class="px-2 py-1.5 font-black text-slate-400 text-right">Crédit</th></tr></thead>
                            <tbody id="importSampleBody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="importProgress" class="hidden">
                    <div class="bg-blue-50 rounded-xl p-4 text-center">
                        <div class="w-8 h-8 border-3 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-2"></div>
                        <p id="importProgressText" class="text-sm font-bold text-blue-700">Import en cours…</p>
                    </div>
                </div>
                <div id="importResult" class="hidden"></div>
            </div>
            <div class="p-5 border-t border-slate-200 flex justify-end gap-2">
                <button onclick="closeImportModal()" class="px-4 py-2 rounded-xl text-[11px] font-bold text-slate-500 hover:bg-slate-100 transition-colors">Annuler</button>
                <button id="importConfirmBtn" onclick="doImport()" class="px-4 py-2 rounded-xl text-[11px] font-bold bg-blue-600 text-white hover:bg-blue-700 transition-colors hidden"><i class="fas fa-upload mr-1"></i>Importer les lignes</button>
            </div>
        </div>
    </div>

    <script>
    // ═══════════════════════════════════════
    // ANALYSE DÉTAILLÉE DES DÉPENSES v2
    // ═══════════════════════════════════════

    const API = '/api/v1';
    const EUR = v => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 2 }).format(v || 0);
    const EUR0 = v => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR', maximumFractionDigits: 0 }).format(v || 0);
    const PCT = v => (v || 0).toFixed(1) + '%';
    const COLORS = ['#3b82f6','#f59e0b','#ef4444','#10b981','#8b5cf6','#ec4899','#06b6d4','#f97316','#84cc16'];
    const MONTHS_FR = ['Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'];
    const dateFR = d => d ? new Date(d + 'T00:00:00').toLocaleDateString('fr-FR') : '—';

    let currentData = null, compareData = null;
    let linesState = { sort: 'date', order: 'desc', page: 1, journal: '', compte: '', search: '' };

    // ── Init ──
    async function init() {
        const yearsResp = await fetch(`${API}/years/list.php`);
        const yearsJson = await yearsResp.json();
        const years = yearsJson.data || [];

        const sel = document.getElementById('yearSelect');
        const cmp = document.getElementById('yearCompare');
        years.forEach(y => { sel.add(new Option(y, y)); cmp.add(new Option(y, y)); });
        if (years.length > 1) cmp.value = years[1];

        sel.addEventListener('change', () => { linesState.page = 1; loadAll(); });
        cmp.addEventListener('change', () => loadAll());

        // Sort buttons
        document.querySelectorAll('.sort-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const field = btn.dataset.sort;
                if (linesState.sort === field) {
                    linesState.order = linesState.order === 'desc' ? 'asc' : 'desc';
                } else {
                    linesState.sort = field;
                    linesState.order = 'desc';
                }
                linesState.page = 1;
                updateSortIndicators();
                loadLines();
            });
        });

        function updateSortIndicators() {
            document.querySelectorAll('.sort-btn').forEach(btn => {
                const icon = btn.querySelector('i');
                if (!icon) return;
                if (btn.dataset.sort === linesState.sort) {
                    btn.classList.add('text-blue-600');
                    btn.classList.remove('text-slate-400');
                    icon.className = linesState.order === 'asc' ? 'fas fa-sort-up ml-0.5 text-blue-500' : 'fas fa-sort-down ml-0.5 text-blue-500';
                } else {
                    btn.classList.remove('text-blue-600');
                    btn.classList.add('text-slate-400');
                    icon.className = 'fas fa-sort ml-0.5 text-slate-300';
                }
            });
        }

        // Filters
        document.getElementById('filterJournal').addEventListener('change', e => { linesState.journal = e.target.value; linesState.page = 1; loadLines(); });
        document.getElementById('filterCompte').addEventListener('change', e => { linesState.compte = e.target.value; linesState.page = 1; loadLines(); });
        
        let searchTimeout;
        document.getElementById('searchLines').addEventListener('input', e => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { linesState.search = e.target.value; linesState.page = 1; loadLines(); }, 300);
        });

        // Export CSV
        document.getElementById('exportCsv').addEventListener('click', exportCSV);

        await loadAll();
    }

    async function loadAll() {
        const year = document.getElementById('yearSelect').value;
        const compareYear = document.getElementById('yearCompare').value;

        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('content').classList.add('hidden');

        try {
            const expResp = await fetch(`${API}/expenses/deep-dive.php?exercice=${year}`);
            const expJson = await expResp.json();
            currentData = expJson.data;

            if (compareYear && compareYear !== year) {
                const cExpResp = await fetch(`${API}/expenses/deep-dive.php?exercice=${compareYear}`);
                const cExpJson = await cExpResp.json();
                compareData = cExpJson.data;
            } else {
                compareData = null;
            }

            renderSummary();
            renderCategories();
            renderCompare();
            renderMonthly();
            renderFournisseurs();
            renderAlerts();
            loadBankFees();
            await loadLines();
        } catch (e) {
            console.error('Erreur:', e);
        }

        document.getElementById('loading').classList.add('hidden');
        document.getElementById('content').classList.remove('hidden');
    }

    // ── Load lines ──
    async function loadLines() {
        const year = document.getElementById('yearSelect').value;
        const params = new URLSearchParams({
            exercice: year,
            page: linesState.page,
            per_page: 100,
            sort: linesState.sort,
            order: linesState.order,
        });
        if (linesState.journal) params.set('journal', linesState.journal);
        if (linesState.compte) params.set('compte', linesState.compte);
        if (linesState.search) params.set('search', linesState.search);

        try {
            const resp = await fetch(`${API}/expenses/lines.php?${params}`);
            const json = await resp.json();
            if (json.success) {
                renderLines(json.data);
                renderFilters(json.data.filters);
            }
        } catch (e) {
            console.error('Erreur lignes:', e);
        }
    }

    // ── Summary ──
    function renderSummary() {
        const s = currentData.synthese;
        const c = compareData?.synthese;
        document.getElementById('totalCharges').textContent = EUR0(s.total_charges);
        document.getElementById('chargesFixes').textContent = EUR0(s.charges_fixes);
        document.getElementById('chargesVariables').textContent = EUR0(s.charges_variables);
        document.getElementById('pctFixes').textContent = PCT(s.pct_fixes) + ' du total';
        document.getElementById('pctVariables').textContent = PCT(s.pct_variables) + ' du total';
        document.getElementById('nbFournisseurs').textContent = s.nb_fournisseurs;
        const a = s.nb_doublons_detectes + s.nb_variations_atypiques;
        document.getElementById('nbAlerts').textContent = a > 0 ? `${a} alertes` : 'Aucune alerte';

        if (c) {
            const v = ((s.total_charges - c.total_charges) / (c.total_charges || 1) * 100);
            const el = document.getElementById('totalChargesVar');
            el.textContent = (v >= 0 ? '+' : '') + v.toFixed(1) + '% vs N-1';
            el.className = `text-[10px] font-bold mt-0.5 ${v > 5 ? 'text-red-500' : v < -5 ? 'text-green-500' : 'text-slate-400'}`;
            el.classList.remove('hidden');
        } else {
            document.getElementById('totalChargesVar').classList.add('hidden');
        }
    }

    // ── Catégories ──
    function renderCategories() {
        const cats = currentData.par_categorie;
        const cmpCats = compareData?.par_categorie;
        const max = Math.max(...cats.map(c => c.montant), 1);
        document.getElementById('categoriesChart').innerHTML = cats.map((cat, i) => {
            const cmp = cmpCats?.find(c => c.code === cat.code);
            const varHtml = cmp ? (() => { const v = ((cat.montant - cmp.montant) / (cmp.montant || 1) * 100); return `<span class="${v > 5 ? 'text-red-500' : v < -5 ? 'text-green-500' : 'text-slate-400'} text-[10px] font-bold">${v >= 0 ? '+' : ''}${v.toFixed(1)}%</span>`; })() : '';
            return `<div class="flex items-center gap-2">
                <div class="w-28 sm:w-40 shrink-0"><p class="text-[11px] font-bold text-slate-700 truncate">${cat.label}</p><p class="text-[9px] text-slate-400">Classe ${cat.code} · ${cat.nb_ecritures} écriture(s)</p></div>
                <div class="flex-1 bg-slate-100 rounded-full h-4 overflow-hidden cursor-pointer" onclick="showCategoryDetail('${cat.code}')" title="Voir le détail"><div class="h-full rounded-full bar-animate" style="width:${(cat.montant/max*100).toFixed(1)}%;background:${COLORS[i%COLORS.length]}"></div></div>
                <span class="text-[11px] font-black text-slate-900 w-20 text-right shrink-0">${EUR0(cat.montant)}</span>
                <span class="text-[9px] text-slate-400 w-10 text-right shrink-0">${PCT(cat.pct_total)}</span>
                ${varHtml}
                <button onclick="showCategoryDetail('${cat.code}')" class="shrink-0 bg-slate-100 hover:bg-blue-500 hover:text-white text-slate-500 px-2 py-1 rounded-lg text-[9px] font-bold transition-all" title="Voir les écritures de cette catégorie"><i class="fas fa-search-plus mr-0.5"></i>Détail</button>
            </div>`;
        }).join('');
    }

    // ── Show category detail: modal with filtered lines ──
    let detailState = { code: '', label: '', page: 1, search: '', sort: 'montant', order: 'desc', sousCompte: '' };
    let counterpartState = { page: 1, search: '' };
    let counterpartSearchTimeout = null;
    let detailSearchTimeout = null;
    const CAT_LABELS = { '60':'Achats (matières, marchandises)','61':'Services extérieurs','62':'Autres services extérieurs','63':'Impôts, taxes et versements','64':'Charges de personnel','65':'Autres charges de gestion','66':'Charges financières','67':'Charges exceptionnelles','68':'Dotations amort./provisions' };
    // Mapping classe 6 → contreparties (classe 4)
    const COUNTERPART_MAP = {
        '64': { compte: '421', title: 'Détail par salarié', icon: 'fa-users', color: 'green' },
    };

    function showCategoryDetail(code) {
        detailState.code = String(code);
        detailState.label = CAT_LABELS[detailState.code] || `Classe ${code}`;
        detailState.page = 1;
        detailState.search = '';
        detailState.sousCompte = '';
        detailState.sort = 'montant';
        detailState.order = 'desc';
        counterpartState = { page: 1, search: '' };
        document.getElementById('detailTitle').innerHTML = `<i class="fas fa-search-plus mr-1.5 text-blue-500"></i>Détail : ${detailState.label}`;
        document.getElementById('detailSubtitle').textContent = `Classe ${code} · Exercice ${document.getElementById('yearSelect').value}`;
        document.getElementById('detailSearch').value = '';
        document.getElementById('detailSort').value = 'montant-desc';
        document.getElementById('detailSousCompte').innerHTML = '<option value="">Tous sous-comptes</option>';
        document.getElementById('counterpartSection').classList.add('hidden');
        document.getElementById('counterpartSearch').value = '';
        document.getElementById('detailLoading').classList.remove('hidden');
        document.getElementById('detailContent').classList.add('hidden');
        document.getElementById('detailModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        loadDetailPage(true);
    }

    function closeDetailModal() {
        document.getElementById('detailModal').classList.add('hidden');
        document.body.style.overflow = '';
    }

    // Wire up detail modal filters
    function currentDetailLoader() {
        return detailState.code.includes(',') ? loadBankFeesDetail : loadDetailPage;
    }

    (function initDetailFilters() {
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('detailSearch').addEventListener('input', e => {
                clearTimeout(detailSearchTimeout);
                detailSearchTimeout = setTimeout(() => {
                    detailState.search = e.target.value;
                    detailState.page = 1;
                    currentDetailLoader()();
                }, 300);
            });
            document.getElementById('detailSort').addEventListener('change', e => {
                const [s, o] = e.target.value.split('-');
                detailState.sort = s;
                detailState.order = o;
                detailState.page = 1;
                currentDetailLoader()();
            });
            document.getElementById('detailSousCompte').addEventListener('change', e => {
                detailState.sousCompte = e.target.value;
                detailState.page = 1;
                currentDetailLoader()();
            });
            document.getElementById('counterpartSearch').addEventListener('input', e => {
                clearTimeout(counterpartSearchTimeout);
                counterpartSearchTimeout = setTimeout(() => {
                    counterpartState.search = e.target.value;
                    counterpartState.page = 1;
                    loadCounterparts();
                }, 300);
            });
        });
    })();

    async function loadDetailPage(loadSousComptes = false) {
        const year = document.getElementById('yearSelect').value;
        const compteFilter = detailState.sousCompte || detailState.code;
        const params = new URLSearchParams({
            exercice: year, page: detailState.page, per_page: 200,
            compte: compteFilter, sort: detailState.sort, order: detailState.order
        });
        if (detailState.search) params.set('search', detailState.search);
        try {
            const resp = await fetch(`${API}/expenses/lines.php?${params}`);
            const json = await resp.json();
            if (!json.success) throw new Error(json.error);
            // Populate sub-accounts selector from filters
            if (loadSousComptes && json.data.filters?.account_prefixes) {
                const sel = document.getElementById('detailSousCompte');
                sel.innerHTML = '<option value="">Tous sous-comptes</option>';
                // Fetch all accounts (unfiltered) to populate sub-account filter
                const allParams = new URLSearchParams({ exercice: year, per_page: 1, compte: detailState.code });
                const allResp = await fetch(`${API}/expenses/lines.php?${allParams}`);
                const allJson = await allResp.json();
                if (allJson.success && allJson.data.filters?.account_prefixes) {
                    allJson.data.filters.account_prefixes.forEach(a => {
                        sel.add(new Option(`${a.prefix} — ${a.label?.substring(0,30) || ''} (${a.nb})`, a.prefix));
                    });
                }
            }
            renderDetailModal(json.data, json.data.source || 'ecritures');
            // Load counterpart accounts if applicable
            const cp = COUNTERPART_MAP[detailState.code];
            if (cp) loadCounterparts();
            else document.getElementById('counterpartSection').classList.add('hidden');
        } catch (e) {
            document.getElementById('detailLoading').classList.add('hidden');
            document.getElementById('detailContent').classList.remove('hidden');
            document.getElementById('detailContent').innerHTML = `<div class="text-center py-8 text-red-500 font-bold">${e.message}</div>`;
        }
    }

    function detailSortBy(field) {
        if (detailState.sort === field) {
            detailState.order = detailState.order === 'desc' ? 'asc' : 'desc';
        } else {
            detailState.sort = field;
            detailState.order = 'desc';
        }
        detailState.page = 1;
        // Update sort dropdown to match
        const key = `${detailState.sort}-${detailState.order}`;
        const sel = document.getElementById('detailSort');
        for (const opt of sel.options) { if (opt.value === key) { sel.value = key; break; } }
        currentDetailLoader()();
    }

    function updateDetailSortIcons() {
        ['date','compte','libelle','debit','credit','montant'].forEach(f => {
            const icon = document.getElementById('dsort-' + f);
            if (!icon) return;
            if (detailState.sort === f) {
                icon.className = detailState.order === 'asc' ? 'fas fa-sort-up ml-0.5 text-blue-500' : 'fas fa-sort-down ml-0.5 text-blue-500';
            } else {
                icon.className = 'fas fa-sort ml-0.5 text-slate-300';
            }
        });
    }

    function renderDetailModal(data, source) {
        const { lines, pagination, totals } = data;
        document.getElementById('detailLoading').classList.add('hidden');
        document.getElementById('detailContent').classList.remove('hidden');

        // Note si données agrégées
        const noteEl = document.getElementById('detailNote');
        if (source === 'report') {
            noteEl.classList.remove('hidden');
            document.getElementById('detailNoteText').textContent = 'Vue agrégée par compte comptable. Pour le détail ligne par ligne (nom salarié, facture…), un import FEC est disponible depuis le header.';
        } else {
            noteEl.classList.add('hidden');
        }

        updateDetailSortIcons();

        // Stats
        document.getElementById('detailStats').innerHTML = `
            <div class="bg-blue-50 rounded-xl p-3 text-center">
                <p class="text-lg font-black text-blue-700">${EUR0(totals.solde)}</p>
                <p class="text-[9px] font-bold text-blue-400 uppercase">Total ${detailState.label.split(' ')[0]}</p>
            </div>
            <div class="bg-slate-50 rounded-xl p-3 text-center">
                <p class="text-lg font-black text-slate-700">${totals.nb_ecritures}</p>
                <p class="text-[9px] font-bold text-slate-400 uppercase">Écritures</p>
            </div>
            <div class="bg-slate-50 rounded-xl p-3 text-center">
                <p class="text-lg font-black text-slate-700">${lines.length > 0 ? EUR0(Math.max(...lines.map(l=>l.montant))) : '—'}</p>
                <p class="text-[9px] font-bold text-slate-400 uppercase">Max unitaire</p>
            </div>`;

        // Table body
        document.getElementById('detailBody').innerHTML = lines.map(l => `
            <tr class="border-b border-slate-50 hover:bg-blue-50/40 transition-colors">
                <td class="px-3 py-2 text-[11px] text-slate-600 whitespace-nowrap">${dateFR(l.date)}</td>
                <td class="px-3 py-2"><span class="text-[10px] font-bold bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded">${l.journal}</span></td>
                <td class="px-3 py-2"><span class="text-[11px] font-mono font-bold text-blue-600">${l.compte}</span><br><span class="text-[9px] text-slate-400">${l.compte_lib || ''}</span></td>
                <td class="px-3 py-2 text-[11px] text-slate-700 truncate max-w-[250px]" title="${(l.libelle||'').replace(/"/g,'&quot;')}">${l.libelle || '—'}</td>
                <td class="px-3 py-2 text-[10px] text-slate-400 whitespace-nowrap">${l.piece || '—'}</td>
                <td class="px-3 py-2 text-right text-[11px] font-bold ${l.debit > 0 ? 'text-slate-900' : 'text-slate-300'} whitespace-nowrap">${l.debit > 0 ? EUR(l.debit) : '—'}</td>
                <td class="px-3 py-2 text-right text-[11px] font-bold ${l.credit > 0 ? 'text-slate-900' : 'text-slate-300'} whitespace-nowrap">${l.credit > 0 ? EUR(l.credit) : '—'}</td>
                <td class="px-3 py-2 text-right text-[11px] font-black ${l.montant >= 0 ? 'text-red-600' : 'text-green-600'} whitespace-nowrap">${EUR(l.montant)}</td>
            </tr>`).join('');

        document.getElementById('detailTotalDebit').textContent = EUR(totals.debit);
        document.getElementById('detailTotalCredit').textContent = EUR(totals.credit);
        document.getElementById('detailTotalMontant').textContent = EUR(totals.solde);

        // Pagination
        const { page, total_pages, total } = pagination;
        document.getElementById('detailPagInfo').textContent = `Page ${page}/${total_pages} · ${total} lignes`;
        const btns = document.getElementById('detailPagBtns');
        btns.innerHTML = '';
        if (total_pages > 1) {
            const addBtn = (label, p, active = false) => {
                const btn = document.createElement('button');
                btn.className = `px-2 py-1 rounded-lg border text-[11px] font-bold transition-colors ${active ? 'bg-blue-600 text-white border-blue-600' : 'border-slate-200 text-slate-500 hover:bg-slate-100'}`;
                btn.textContent = label;
                btn.addEventListener('click', () => { detailState.page = p; currentDetailLoader()(); });
                btns.appendChild(btn);
            };
            if (page > 1) addBtn('‹', page - 1);
            for (let i = Math.max(1, page-2); i <= Math.min(total_pages, page+2); i++) addBtn(String(i), i, i === page);
            if (page < total_pages) addBtn('›', page + 1);
        }
    }

    // ── Counterpart accounts (ex: 421 salariés pour classe 64) ──
    async function loadCounterparts() {
        const cp = COUNTERPART_MAP[detailState.code];
        if (!cp) return;
        const year = document.getElementById('yearSelect').value;
        const params = new URLSearchParams({
            exercice: year, page: counterpartState.page, per_page: 200,
            compte: cp.compte, sort: 'credit', order: 'desc', any_class: 1
        });
        if (counterpartState.search) params.set('search', counterpartState.search);
        try {
            const resp = await fetch(`${API}/expenses/lines.php?${params}`);
            const json = await resp.json();
            if (!json.success || !json.data.lines.length) {
                document.getElementById('counterpartSection').classList.add('hidden');
                return;
            }
            renderCounterparts(json.data, cp);
        } catch (e) {
            document.getElementById('counterpartSection').classList.add('hidden');
        }
    }

    function renderCounterparts(data, cp) {
        const { lines, pagination, totals } = data;
        document.getElementById('counterpartSection').classList.remove('hidden');
        document.getElementById('counterpartTitle').innerHTML = `<i class="fas ${cp.icon} mr-1.5 text-${cp.color}-500"></i>${cp.title}`;

        document.getElementById('counterpartBody').innerHTML = lines.map(l => {
            const nom = l.aux_lib || l.libelle || l.compte_lib || '—';
            const montant = l.credit > 0 ? l.credit : l.debit;
            return `
            <tr class="border-b border-slate-50 hover:bg-green-50/40 transition-colors">
                <td class="px-3 py-2 text-[11px] text-slate-600 whitespace-nowrap">${dateFR(l.date)}</td>
                <td class="px-3 py-2 text-[11px] font-mono font-bold text-green-600 whitespace-nowrap">${l.compte}</td>
                <td class="px-3 py-2 text-[11px] font-bold text-slate-800">${nom}</td>
                <td class="px-3 py-2 text-[11px] text-slate-500 truncate max-w-[200px]">${l.libelle || '—'}</td>
                <td class="px-3 py-2 text-right text-[11px] font-black text-green-700 whitespace-nowrap">${EUR(montant)}</td>
            </tr>`;
        }).join('');

        const totalMontant = lines.reduce((s, l) => s + (l.credit > 0 ? l.credit : l.debit), 0);
        document.getElementById('counterpartTotal').textContent = EUR(totalMontant);

        // Pagination
        const { page, total_pages, total } = pagination;
        document.getElementById('counterpartPagInfo').textContent = `Page ${page}/${total_pages} · ${total} lignes`;
        const btns = document.getElementById('counterpartPagBtns');
        btns.innerHTML = '';
        if (total_pages > 1) {
            const addBtn = (label, p, active = false) => {
                const btn = document.createElement('button');
                btn.className = `px-2 py-1 rounded-lg border text-[11px] font-bold transition-colors ${active ? 'bg-green-600 text-white border-green-600' : 'border-slate-200 text-slate-500 hover:bg-slate-100'}`;
                btn.textContent = label;
                btn.addEventListener('click', () => { counterpartState.page = p; loadCounterparts(); });
                btns.appendChild(btn);
            };
            if (page > 1) addBtn('‹', page - 1);
            for (let i = Math.max(1, page-2); i <= Math.min(total_pages, page+2); i++) addBtn(String(i), i, i === page);
            if (page < total_pages) addBtn('›', page + 1);
        }
    }

    // ── Compare ──
    function renderCompare() {
        const section = document.getElementById('compareSection');
        if (!compareData) { section.classList.add('hidden'); return; }
        section.classList.remove('hidden');
        const d = currentData, c = compareData;
        document.getElementById('compareYearsLabel').textContent = `${d.exercice} vs ${c.exercice}`;
        // Normalize codes to string to avoid "60" !== 60 mismatch
        const norm = cats => cats.map(x => ({...x, code: String(x.code)}));
        const dCats = norm(d.par_categorie), cCats = norm(c.par_categorie);
        const allCodes = new Set([...dCats.map(x=>x.code), ...cCats.map(x=>x.code)]);
        const rows = [...allCodes].sort().map(code => {
            const curr = dCats.find(x => x.code === code) || { label: code, montant: 0 };
            const prev = cCats.find(x => x.code === code) || { label: code, montant: 0 };
            const diff = curr.montant - prev.montant;
            const pct = prev.montant ? (diff / prev.montant * 100) : (curr.montant ? 100 : 0);
            return { code, label: curr.label || prev.label || CAT_LABELS[code] || `Classe ${code}`, curr: curr.montant, prev: prev.montant, pct };
        });
        const maxV = Math.max(...rows.map(r => Math.max(r.curr, r.prev)), 1);
        document.getElementById('compareChart').innerHTML = rows.map(r => `
            <div class="space-y-1">
                <div class="flex justify-between items-center">
                    <span class="text-[11px] font-bold text-slate-700">${r.label}</span>
                    <span class="text-[11px] font-bold ${r.pct > 5 ? 'text-red-500' : r.pct < -5 ? 'text-green-500' : 'text-slate-400'}">${r.pct >= 0 ? '+' : ''}${r.pct.toFixed(1)}%</span>
                </div>
                <div class="flex items-center gap-2 text-[9px]">
                    <span class="w-8 text-right text-blue-600 font-bold">${d.exercice}</span>
                    <div class="flex-1 bg-slate-100 rounded-full h-2.5 overflow-hidden"><div class="h-full bg-blue-500 rounded-full" style="width:${(r.curr/maxV*100).toFixed(1)}%"></div></div>
                    <span class="w-16 text-right font-bold text-slate-700">${EUR0(r.curr)}</span>
                </div>
                <div class="flex items-center gap-2 text-[9px]">
                    <span class="w-8 text-right text-slate-400 font-bold">${c.exercice}</span>
                    <div class="flex-1 bg-slate-100 rounded-full h-2.5 overflow-hidden"><div class="h-full bg-slate-300 rounded-full" style="width:${(r.prev/maxV*100).toFixed(1)}%"></div></div>
                    <span class="w-16 text-right font-bold text-slate-400">${EUR0(r.prev)}</span>
                </div>
            </div>`).join('');
    }

    // ── Monthly ──
    function renderMonthly() {
        const months = currentData.evolution_mensuelle;
        const cmpMonths = compareData?.evolution_mensuelle;
        const container = document.getElementById('monthlyChart');
        if (!months.length) { container.innerHTML = '<p class="text-xs text-slate-400 text-center py-8">Aucune donnée</p>'; return; }
        const year = currentData.exercice;
        const data = Array.from({ length: 12 }, (_, i) => {
            const key = `${year}-${String(i + 1).padStart(2, '0')}`;
            return { month: MONTHS_FR[i], value: months.find(m => m.mois === key)?.total || 0 };
        });
        let cmpData = null;
        if (cmpMonths?.length) {
            const cYear = compareData.exercice;
            cmpData = Array.from({ length: 12 }, (_, i) => {
                const key = `${cYear}-${String(i + 1).padStart(2, '0')}`;
                return { value: cmpMonths.find(m => m.mois === key)?.total || 0 };
            });
        }
        const maxV = Math.max(...data.map(d => d.value), ...(cmpData?.map(d => d.value) || [0]), 1);
        container.innerHTML = `
            <div class="flex items-end justify-between gap-1 h-full px-1" style="min-height:160px">
                ${data.map((d, i) => {
                    const h = (d.value / maxV * 140);
                    const ch = cmpData ? (cmpData[i].value / maxV * 140) : 0;
                    return `<div class="flex-1 flex flex-col items-center justify-end gap-0.5 h-full">
                        ${d.value > 0 ? `<span class="text-[7px] font-bold text-slate-400">${EUR0(d.value)}</span>` : ''}
                        <div class="flex items-end gap-px w-full justify-center" style="height:150px">
                            ${cmpData ? `<div class="bg-slate-200 rounded-t w-1/3" style="height:${ch}px"></div>` : ''}
                            <div class="bg-blue-500 rounded-t ${cmpData ? 'w-1/3' : 'w-2/3'}" style="height:${h}px"></div>
                        </div>
                        <span class="text-[8px] font-bold text-slate-400">${d.month}</span>
                    </div>`;
                }).join('')}
            </div>
            ${cmpData ? `<div class="flex justify-center gap-4 mt-2 text-[9px] font-bold">
                <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded bg-blue-500 inline-block"></span>${currentData.exercice}</span>
                <span class="flex items-center gap-1"><span class="w-2.5 h-2.5 rounded bg-slate-200 inline-block"></span>${compareData.exercice}</span>
            </div>` : ''}`;
    }

    // ── Fournisseurs ──
    function renderFournisseurs() {
        const f = currentData.par_fournisseur;
        const container = document.getElementById('fournisseursChart');
        if (!f.length) { container.innerHTML = '<p class="text-xs text-slate-400 text-center py-4">Aucun fournisseur</p>'; return; }
        const max = Math.max(...f.map(x => x.montant), 1);
        container.innerHTML = f.slice(0, 10).map((fi, i) => `
            <div class="flex items-center gap-2">
                <div class="w-6 h-6 rounded-lg bg-slate-100 flex items-center justify-center text-[10px] font-black text-slate-500 shrink-0">${i + 1}</div>
                <div class="flex-1 min-w-0"><p class="text-[11px] font-bold text-slate-700 truncate">${fi.nom || 'Non identifié'}</p><p class="text-[9px] text-slate-400">${fi.nb_factures} fact.</p></div>
                <div class="w-20 sm:w-32 bg-slate-100 rounded-full h-3 overflow-hidden shrink-0"><div class="h-full bg-blue-500 rounded-full bar-animate" style="width:${(fi.montant/max*100).toFixed(1)}%"></div></div>
                <span class="text-[11px] font-black text-slate-900 w-16 text-right shrink-0">${EUR0(fi.montant)}</span>
            </div>`).join('');
    }

    // ── Lines table ──
    function renderLines(data) {
        const { lines, pagination, totals } = data;
        document.getElementById('linesCount').textContent = `${totals.nb_ecritures} écritures · Solde: ${EUR(totals.solde)}`;

        const tbody = document.getElementById('linesBody');
        tbody.innerHTML = lines.map(l => `
            <tr class="line-row transition-colors">
                <td class="px-3 py-2 text-[11px] text-slate-600 font-medium whitespace-nowrap">${dateFR(l.date)}</td>
                <td class="px-3 py-2"><span class="text-[10px] font-bold bg-slate-100 text-slate-600 px-1.5 py-0.5 rounded">${l.journal}</span></td>
                <td class="px-3 py-2 text-[11px] font-mono font-bold text-blue-600 whitespace-nowrap">${l.compte}</td>
                <td class="px-3 py-2 text-[11px] text-slate-500 truncate max-w-[140px] hidden md:table-cell">${l.compte_lib || '—'}</td>
                <td class="px-3 py-2 text-[10px] text-slate-400 whitespace-nowrap">${l.piece || '—'}</td>
                <td class="px-3 py-2 text-[11px] text-slate-700 truncate max-w-[200px]" title="${(l.libelle||'').replace(/"/g,'&quot;')}">${l.libelle || '—'}</td>
                <td class="px-3 py-2 text-right text-[11px] font-bold ${l.debit > 0 ? 'text-slate-900' : 'text-slate-300'} whitespace-nowrap">${l.debit > 0 ? EUR(l.debit) : '—'}</td>
                <td class="px-3 py-2 text-right text-[11px] font-bold ${l.credit > 0 ? 'text-slate-900' : 'text-slate-300'} whitespace-nowrap">${l.credit > 0 ? EUR(l.credit) : '—'}</td>
                <td class="px-3 py-2 text-right text-[11px] font-black ${l.montant >= 0 ? 'text-red-600' : 'text-green-600'} whitespace-nowrap">${EUR(l.montant)}</td>
            </tr>`).join('');

        document.getElementById('totalDebit').textContent = EUR(totals.debit);
        document.getElementById('totalCredit').textContent = EUR(totals.credit);
        document.getElementById('totalSolde').textContent = EUR(totals.solde);

        // Pagination
        const { page, total_pages, total } = pagination;
        document.getElementById('paginationInfo').textContent = `Page ${page}/${total_pages} · ${total} lignes au total`;
        const btns = document.getElementById('paginationBtns');
        btns.innerHTML = '';
        if (total_pages <= 1) return;

        const addBtn = (label, p, active = false) => {
            const btn = document.createElement('button');
            btn.className = `page-btn rounded-lg border text-[11px] font-bold transition-colors ${active ? 'active border-slate-900' : 'border-slate-200 text-slate-500 hover:bg-slate-100'}`;
            btn.textContent = label;
            btn.addEventListener('click', () => { linesState.page = p; loadLines(); window.scrollTo({ top: document.getElementById('linesTable').offsetTop - 80, behavior: 'smooth' }); });
            btns.appendChild(btn);
        };

        if (page > 1) addBtn('‹', page - 1);
        const start = Math.max(1, page - 2);
        const end = Math.min(total_pages, page + 2);
        if (start > 1) { addBtn('1', 1); if (start > 2) { const sp = document.createElement('span'); sp.textContent = '…'; sp.className = 'text-slate-300 px-1 self-center'; btns.appendChild(sp); } }
        for (let i = start; i <= end; i++) addBtn(String(i), i, i === page);
        if (end < total_pages) { if (end < total_pages - 1) { const sp = document.createElement('span'); sp.textContent = '…'; sp.className = 'text-slate-300 px-1 self-center'; btns.appendChild(sp); } addBtn(String(total_pages), total_pages); }
        if (page < total_pages) addBtn('›', page + 1);
    }

    // ── Filters ──
    function renderFilters(filters) {
        const jSel = document.getElementById('filterJournal');
        const cSel = document.getElementById('filterCompte');
        if (jSel.options.length <= 1) {
            filters.journals.forEach(j => jSel.add(new Option(`${j.journal_code} — ${j.journal_lib || ''}`, j.journal_code)));
        }
        if (cSel.options.length <= 1) {
            const labels = { '60':'Achats','61':'Serv. ext.','62':'Autres serv.','63':'Impôts','64':'Personnel','65':'Autres charges','66':'Charges fin.','67':'Exceptionnel','68':'Dotations' };
            filters.account_prefixes.forEach(a => cSel.add(new Option(`${a.prefix} — ${labels[a.prefix] || a.label} (${a.nb})`, a.prefix)));
        }
    }

    // ── Export CSV ──
    async function exportCSV() {
        const year = document.getElementById('yearSelect').value;
        const params = new URLSearchParams({ exercice: year, per_page: 10000, sort: linesState.sort, order: linesState.order });
        if (linesState.journal) params.set('journal', linesState.journal);
        if (linesState.compte) params.set('compte', linesState.compte);
        if (linesState.search) params.set('search', linesState.search);

        const resp = await fetch(`${API}/expenses/lines.php?${params}`);
        const json = await resp.json();
        if (!json.success) return;

        const lines = json.data.lines;
        const headers = ['Date','Journal','Compte','Libellé Compte','Pièce','Libellé Écriture','Débit','Crédit','Solde'];
        const rows = lines.map(l => [l.date, l.journal, l.compte, l.compte_lib, l.piece, l.libelle, l.debit, l.credit, l.montant]);
        const csv = [headers, ...rows].map(r => r.map(v => `"${String(v ?? '').replace(/"/g, '""')}"`).join(';')).join('\n');
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `depenses_${year}.csv`; a.click();
        URL.revokeObjectURL(url);
    }

    // ── Alerts ──
    function renderAlerts() {
        const d = currentData;
        const section = document.getElementById('alertsSection');
        const content = document.getElementById('alertsContent');
        const alerts = [];
        if (d.doublons_factures?.length) alerts.push(...d.doublons_factures.map(f => `<div class="flex items-start gap-2 p-2.5 bg-red-50 rounded-xl"><i class="fas fa-copy text-red-400 mt-0.5"></i><div><p class="text-[11px] font-bold text-red-700">Doublon</p><p class="text-[10px] text-red-500">${f.fournisseur || '?'} · ${EUR(f.montant)} · ${f.nb_occurrences}x</p></div></div>`));
        if (d.variations_atypiques?.length) alerts.push(...d.variations_atypiques.map(v => { const moisLabel = v.mois ? v.mois.replace(/(\d{4})-(\d{2})/, (_, y, m) => MONTHS_FR[parseInt(m)-1] + ' ' + y) : ''; const desc = v.categorie ? `${v.categorie} (${moisLabel})` : moisLabel; return `<div class="flex items-start gap-2 p-2.5 bg-amber-50 rounded-xl"><i class="fas fa-chart-line text-amber-400 mt-0.5"></i><div><p class="text-[11px] font-bold text-amber-700">Variation atypique</p><p class="text-[10px] text-amber-500">${desc} · ${v.variation_pct > 0 ? '+' : ''}${v.variation_pct?.toFixed(1)}%</p></div></div>`; }));
        if (alerts.length) { section.classList.remove('hidden'); content.innerHTML = alerts.join(''); } else { section.classList.add('hidden'); }
    }

    // ═══════════════════════════════════════
    // IMPORT FEC
    // ═══════════════════════════════════════

    let parsedFecLines = [];
    let fecExercice = null;

    function showImportModal() {
        document.getElementById('importModal').classList.remove('hidden');
        document.getElementById('importPreview').classList.add('hidden');
        document.getElementById('importProgress').classList.add('hidden');
        document.getElementById('importResult').classList.add('hidden');
        document.getElementById('importConfirmBtn').classList.add('hidden');
        document.getElementById('importDropZone').classList.remove('hidden');
        parsedFecLines = [];
        fecExercice = null;
    }

    function closeImportModal() {
        document.getElementById('importModal').classList.add('hidden');
    }

    // Drag & drop + click
    (function initImportUI() {
        const zone = document.getElementById('importDropZone');
        const input = document.getElementById('fecFileInput');
        if (!zone || !input) return;

        zone.addEventListener('click', () => input.click());
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('border-blue-400', 'bg-blue-50'); });
        zone.addEventListener('dragleave', () => { zone.classList.remove('border-blue-400', 'bg-blue-50'); });
        zone.addEventListener('drop', e => {
            e.preventDefault();
            zone.classList.remove('border-blue-400', 'bg-blue-50');
            if (e.dataTransfer.files.length) handleFecFile(e.dataTransfer.files[0]);
        });
        input.addEventListener('change', e => { if (e.target.files.length) handleFecFile(e.target.files[0]); });
    })();

    function handleFecFile(file) {
        document.getElementById('importFileName').textContent = file.name;
        const reader = new FileReader();
        reader.onload = e => {
            try {
                const result = parseFEC(e.target.result);
                parsedFecLines = result.lines;
                fecExercice = result.exercice;
                showImportPreview(result);
            } catch (err) {
                alert('Erreur de lecture FEC: ' + err.message);
            }
        };
        reader.readAsText(file, 'UTF-8');
    }

    function parseFEC(text) {
        // Detect separator: tab, pipe, or semicolon
        const firstLine = text.split('\n')[0];
        let sep = '\t';
        if (firstLine.includes('|') && !firstLine.includes('\t')) sep = '|';
        else if (firstLine.includes(';') && !firstLine.includes('\t') && !firstLine.includes('|')) sep = ';';

        const rawLines = text.split(/\r?\n/).filter(l => l.trim());
        if (rawLines.length < 2) throw new Error('Fichier vide ou invalide');

        // Parse header
        const headers = rawLines[0].split(sep).map(h => h.trim().replace(/^"|"$/g, ''));

        // Map FEC standard headers to our DB columns
        const headerMap = {};
        const stdNames = {
            'JournalCode': 'journal_code', 'JournalLib': 'journal_lib',
            'EcritureNum': 'ecriture_num', 'EcritureDate': 'ecriture_date',
            'CompteNum': 'compte_num', 'CompteLib': 'compte_lib',
            'CompAuxNum': 'numero_tiers', 'CompAuxLib': 'lib_tiers',
            'PieceRef': 'piece_ref', 'PieceDate': 'date_piece',
            'EcritureLib': 'libelle_ecriture',
            'Debit': 'debit', 'Credit': 'credit',
            'EcritureLet': 'lettrage_flag', 'DateLet': 'date_lettrage',
            'MontantDevise': 'montant_devise', 'Idevise': 'devise_ecriture',
        };
        headers.forEach((h, i) => {
            const key = Object.keys(stdNames).find(k => k.toLowerCase() === h.toLowerCase());
            if (key) headerMap[stdNames[key]] = i;
        });

        if (headerMap['compte_num'] === undefined || headerMap['debit'] === undefined) {
            throw new Error('En-têtes FEC non reconnus. Attendus: JournalCode, CompteNum, Debit, Credit, ...');
        }

        // Parse data lines
        const lines = [];
        let exercice = null;

        for (let i = 1; i < rawLines.length; i++) {
            const cols = rawLines[i].split(sep).map(c => c.trim().replace(/^"|"$/g, ''));
            if (cols.length < 5) continue;

            const get = key => headerMap[key] !== undefined ? (cols[headerMap[key]] || '') : '';

            // Parse date: 20250101 → 2025-01-01
            const rawDate = get('ecriture_date');
            let date = rawDate;
            if (/^\d{8}$/.test(rawDate)) {
                date = rawDate.slice(0, 4) + '-' + rawDate.slice(4, 6) + '-' + rawDate.slice(6, 8);
            }
            const rawPieceDate = get('date_piece');
            let pieceDate = rawPieceDate;
            if (/^\d{8}$/.test(rawPieceDate)) {
                pieceDate = rawPieceDate.slice(0, 4) + '-' + rawPieceDate.slice(4, 6) + '-' + rawPieceDate.slice(6, 8);
            }

            // Parse amounts: French format 1 234,56 → 1234.56
            const parseAmount = s => {
                if (!s) return 0;
                return parseFloat(s.replace(/\s/g, '').replace(',', '.')) || 0;
            };

            // Detect exercice from first date
            if (!exercice && date.length >= 4) {
                exercice = parseInt(date.slice(0, 4));
            }

            lines.push({
                journal_code: get('journal_code'),
                journal_lib: get('journal_lib'),
                ecriture_num: get('ecriture_num'),
                ecriture_date: date,
                compte_num: get('compte_num'),
                compte_lib: get('compte_lib'),
                numero_tiers: get('numero_tiers'),
                lib_tiers: get('lib_tiers'),
                piece_ref: get('piece_ref'),
                date_piece: pieceDate,
                libelle_ecriture: get('libelle_ecriture'),
                debit: parseAmount(get('debit')),
                credit: parseAmount(get('credit')),
                lettrage_flag: get('lettrage_flag'),
                date_lettrage: get('date_lettrage'),
                montant_devise: get('montant_devise'),
                devise_ecriture: get('devise_ecriture'),
            });
        }

        const nbCharges = lines.filter(l => l.compte_num.startsWith('6')).length;

        return { lines, exercice, nbCharges };
    }

    function showImportPreview(result) {
        document.getElementById('importDropZone').classList.add('hidden');
        document.getElementById('importPreview').classList.remove('hidden');
        document.getElementById('importConfirmBtn').classList.remove('hidden');

        document.getElementById('importTotalLines').textContent = result.lines.length.toLocaleString('fr-FR');
        document.getElementById('importChargesLines').textContent = result.nbCharges.toLocaleString('fr-FR');
        document.getElementById('importExercice').textContent = result.exercice || '?';

        // Show sample of first 10 charge lines
        const sample = result.lines.filter(l => l.compte_num.startsWith('6')).slice(0, 10);
        document.getElementById('importSampleBody').innerHTML = sample.map(l => `
            <tr class="border-t border-slate-100">
                <td class="px-2 py-1 text-slate-600">${l.journal_code}</td>
                <td class="px-2 py-1 text-slate-600">${l.ecriture_date}</td>
                <td class="px-2 py-1 font-mono text-blue-600 font-bold">${l.compte_num}</td>
                <td class="px-2 py-1 text-slate-700 truncate max-w-[200px]">${l.libelle_ecriture || l.compte_lib}</td>
                <td class="px-2 py-1 text-right font-bold ${l.debit > 0 ? 'text-slate-900' : 'text-slate-300'}">${l.debit > 0 ? EUR(l.debit) : '—'}</td>
                <td class="px-2 py-1 text-right font-bold ${l.credit > 0 ? 'text-slate-900' : 'text-slate-300'}">${l.credit > 0 ? EUR(l.credit) : '—'}</td>
            </tr>`).join('');
    }

    async function doImport() {
        if (!parsedFecLines.length || !fecExercice) return;

        document.getElementById('importPreview').classList.add('hidden');
        document.getElementById('importConfirmBtn').classList.add('hidden');
        document.getElementById('importProgress').classList.remove('hidden');
        document.getElementById('importProgressText').textContent = `Import de ${parsedFecLines.length.toLocaleString('fr-FR')} lignes…`;

        try {
            // Send in chunks if needed (max ~5000 per request)
            const CHUNK = 5000;
            let totalImported = 0;
            const totalChunks = Math.ceil(parsedFecLines.length / CHUNK);

            for (let c = 0; c < totalChunks; c++) {
                const chunk = parsedFecLines.slice(c * CHUNK, (c + 1) * CHUNK);
                const isFirst = c === 0;

                document.getElementById('importProgressText').textContent = 
                    totalChunks > 1 ? `Envoi lot ${c + 1}/${totalChunks}…` : `Import de ${parsedFecLines.length.toLocaleString('fr-FR')} lignes…`;

                // For the first chunk, the endpoint deletes existing data
                // For subsequent chunks, we need to append
                const resp = await fetch(`${API}/fec/upload.php`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        exercice: fecExercice,
                        lines: chunk,
                        append: !isFirst,
                    })
                });
                const json = await resp.json();
                if (!json.success) throw new Error(json.error || 'Erreur serveur');
                totalImported += json.imported;
            }

            document.getElementById('importProgress').classList.add('hidden');
            document.getElementById('importResult').classList.remove('hidden');
            document.getElementById('importResult').innerHTML = `
                <div class="bg-green-50 rounded-xl p-4 text-center">
                    <i class="fas fa-check-circle text-2xl text-green-500 mb-2"></i>
                    <p class="text-sm font-bold text-green-700">Import réussi !</p>
                    <p class="text-[11px] text-green-600 mt-1">${totalImported.toLocaleString('fr-FR')} lignes importées pour l'exercice ${fecExercice}</p>
                </div>`;

            // Refresh data after 1.5s
            setTimeout(() => {
                closeImportModal();
                // Reset filters
                linesState = { sort: 'date', order: 'desc', page: 1, journal: '', compte: '', search: '' };
                document.getElementById('filterJournal').innerHTML = '<option value="">Tous journaux</option>';
                document.getElementById('filterCompte').innerHTML = '<option value="">Tous comptes</option>';
                document.getElementById('searchLines').value = '';
                loadAll();
            }, 1500);

        } catch (err) {
            document.getElementById('importProgress').classList.add('hidden');
            document.getElementById('importResult').classList.remove('hidden');
            document.getElementById('importResult').innerHTML = `
                <div class="bg-red-50 rounded-xl p-4 text-center">
                    <i class="fas fa-times-circle text-2xl text-red-500 mb-2"></i>
                    <p class="text-sm font-bold text-red-700">Erreur d'import</p>
                    <p class="text-[11px] text-red-500 mt-1">${err.message}</p>
                </div>`;
        }
    }

    // ═══════════════════════════════════════
    // FRAIS BANCAIRES
    // ═══════════════════════════════════════
    const BANK_COLORS = ['#f97316','#ef4444','#8b5cf6','#06b6d4','#ec4899','#10b981'];
    let bankFeesData = null;

    async function loadBankFees() {
        const year = document.getElementById('yearSelect').value;
        try {
            const resp = await fetch(`${API}/expenses/bank-fees.php?exercice=${year}`);
            const json = await resp.json();
            if (json.success && json.data && json.data.total > 0) {
                bankFeesData = json.data;
                renderBankFees(json.data);
                document.getElementById('bankFeesSection').classList.remove('hidden');
            } else {
                document.getElementById('bankFeesSection').classList.add('hidden');
            }
        } catch (e) {
            console.error('Erreur frais bancaires:', e);
            document.getElementById('bankFeesSection').classList.add('hidden');
        }
    }

    function renderBankFees(data) {
        // Subtitle
        document.getElementById('bankFeesSubtitle').textContent = `${data.nb_ecritures} écritures · Exercice ${document.getElementById('yearSelect').value}`;

        // KPI cards — sépare frais purs vs arrêtés de compte (intérêts trimestriels)
        const fraisPurs = data.total_frais_purs ?? data.total;
        const arreteTotal = data.total_arrete_compte ?? 0;
        const arreteNb = data.arrete_compte?.nb ?? 0;
        const mensuel = data.cout_moyen_mensuel || (fraisPurs / 12);
        document.getElementById('bankFeesKPI').innerHTML = `
            <div class="bg-orange-50 rounded-xl p-3 text-center border-2 border-orange-200">
                <p class="text-lg font-black text-orange-700">${EUR0(fraisPurs)}</p>
                <p class="text-[9px] font-bold text-orange-400 uppercase">Frais bancaires purs</p>
                <p class="text-[8px] text-slate-400 mt-0.5">${EUR0(mensuel)}/mois</p>
            </div>
            <div class="bg-red-50 rounded-xl p-3 text-center border border-red-200">
                <p class="text-lg font-black text-red-600">${EUR0(arreteTotal)}</p>
                <p class="text-[9px] font-bold text-red-400 uppercase">Arrêtés de compte</p>
                <p class="text-[8px] text-slate-400 mt-0.5">${arreteNb} écriture${arreteNb > 1 ? 's' : ''} · Intérêts trimestriels</p>
            </div>
            <div class="bg-slate-50 rounded-xl p-3 text-center">
                <p class="text-lg font-black text-slate-700">${EUR0(data.total)}</p>
                <p class="text-[9px] font-bold text-slate-400 uppercase">Total global (627+661+665)</p>
            </div>
            <div class="bg-slate-50 rounded-xl p-3 text-center">
                <p class="text-lg font-black text-slate-700">${data.nb_ecritures}</p>
                <p class="text-[9px] font-bold text-slate-400 uppercase">Écritures</p>
            </div>`;

        // Arrêtés de compte detail (if any)
        if (arreteTotal > 0 && data.arrete_compte?.detail?.length) {
            renderArreteDetail(data.arrete_compte);
        }

        // Pie chart (SVG donut)
        renderBankPieChart(data.par_type || []);

        // Bar chart by bank
        renderBankBarChart(data.par_banque || []);

        // Monthly
        renderBankMonthly(data.par_mois || []);
    }

    function renderArreteDetail(arrete) {
        const section = document.getElementById('bankFeesArreteSection');
        const container = document.getElementById('bankFeesArreteDetail');
        if (!arrete || !arrete.detail?.length) { section.classList.add('hidden'); return; }
        section.classList.remove('hidden');

        const rows = arrete.detail.map(e => {
            const montant = e.montant || e.debit || e.credit || 0;
            const date = e.date || e.ecriture_date || '';
            const dateFr = date.length >= 10 ? date.substring(8,10)+'/'+date.substring(5,7)+'/'+date.substring(0,4) : date;
            return `<div class="flex items-center gap-2 py-1.5 px-2 rounded hover:bg-red-50/60 transition-colors border-b border-slate-100 last:border-0">
                <span class="text-[10px] font-mono text-slate-400 w-20 shrink-0">${dateFr}</span>
                <span class="text-[9px] font-bold bg-red-100 text-red-700 px-1.5 py-0.5 rounded w-10 text-center shrink-0">${e.journal || e.journal_code || ''}</span>
                <span class="text-[10px] font-mono text-slate-500 w-14 shrink-0">${e.compte || e.compte_num || ''}</span>
                <span class="text-[10px] text-slate-700 flex-1 truncate">${e.libelle || e.libelle_ecriture || e.compte_lib || ''}</span>
                <span class="text-[11px] font-black text-red-600 w-20 text-right shrink-0">${EUR(montant)}</span>
            </div>`;
        }).join('');

        container.innerHTML = `
            <div class="bg-red-50/40 border border-red-200 rounded-xl p-3">
                <div class="text-[9px] text-red-400 font-bold mb-2 uppercase">
                    ${arrete.nb} écriture${arrete.nb > 1 ? 's' : ''} · Total : ${EUR(arrete.total)}
                    <span class="text-slate-400 font-normal ml-2">— ${arrete.note || 'Intérêts débiteurs trimestriels prélevés par la banque'}</span>
                </div>
                <div class="divide-y divide-slate-100">${rows}</div>
            </div>`;
    }

    function renderBankPieChart(types) {
        const container = document.getElementById('bankFeesPie');
        if (!types.length) { container.innerHTML = '<p class="text-xs text-slate-400">Aucune donnée</p>'; return; }

        const total = types.reduce((s, t) => s + t.montant, 0);
        const size = 160, cx = size/2, cy = size/2, r = 60, r2 = 40;
        let angle = -Math.PI / 2;

        const paths = types.map((t, i) => {
            const pct = t.montant / total;
            const a1 = angle;
            const a2 = angle + pct * 2 * Math.PI;
            angle = a2;
            const large = pct > 0.5 ? 1 : 0;
            const x1 = cx + r * Math.cos(a1), y1 = cy + r * Math.sin(a1);
            const x2 = cx + r * Math.cos(a2), y2 = cy + r * Math.sin(a2);
            const x3 = cx + r2 * Math.cos(a2), y3 = cy + r2 * Math.sin(a2);
            const x4 = cx + r2 * Math.cos(a1), y4 = cy + r2 * Math.sin(a1);
            return `<path d="M${x1},${y1} A${r},${r} 0 ${large} 1 ${x2},${y2} L${x3},${y3} A${r2},${r2} 0 ${large} 0 ${x4},${y4}Z" fill="${BANK_COLORS[i % BANK_COLORS.length]}" opacity="0.85"><title>${t.label}: ${EUR(t.montant)} (${(pct*100).toFixed(1)}%)</title></path>`;
        }).join('');

        const svg = `<svg viewBox="0 0 ${size} ${size}" width="${size}" height="${size}">${paths}<text x="${cx}" y="${cy-4}" text-anchor="middle" font-size="11" font-weight="900" fill="#1e293b">${EUR0(total)}</text><text x="${cx}" y="${cy+10}" text-anchor="middle" font-size="7" font-weight="700" fill="#94a3b8">TOTAL</text></svg>`;

        const legend = types.map((t, i) => {
            const pct = (t.montant / total * 100).toFixed(1);
            return `<div class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-sm shrink-0" style="background:${BANK_COLORS[i % BANK_COLORS.length]}"></span><span class="text-[10px] font-bold text-slate-700 truncate">${t.label}</span><span class="text-[9px] text-slate-400 ml-auto whitespace-nowrap">${EUR0(t.montant)} · ${pct}%</span></div>`;
        }).join('');

        container.innerHTML = `<div>${svg}</div><div class="space-y-1.5 flex-1 min-w-[140px]">${legend}</div>`;
    }

    function renderBankBarChart(banques) {
        const container = document.getElementById('bankFeesBar');
        if (!banques.length) { container.innerHTML = '<p class="text-xs text-slate-400">Aucune donnée</p>'; return; }
        const max = Math.max(...banques.map(b => b.montant), 1);
        container.innerHTML = banques.map((b, i) => `
            <div class="flex items-center gap-2">
                <div class="w-16 shrink-0"><span class="text-[10px] font-bold bg-orange-100 text-orange-700 px-1.5 py-0.5 rounded">${b.code || '?'}</span></div>
                <div class="flex-1 bg-slate-100 rounded-full h-3 overflow-hidden"><div class="h-full rounded-full bar-animate" style="width:${(b.montant/max*100).toFixed(1)}%;background:${BANK_COLORS[i % BANK_COLORS.length]}"></div></div>
                <span class="text-[10px] font-black text-slate-700 w-16 text-right shrink-0">${EUR0(b.montant)}</span>
                <span class="text-[9px] text-slate-400 w-10 text-right shrink-0">${b.nb}éc.</span>
            </div>`).join('');
    }

    function renderBankMonthly(mois) {
        const container = document.getElementById('bankFeesMonthly');
        if (!mois.length) { container.innerHTML = '<p class="text-xs text-slate-400 text-center py-8">Aucune donnée</p>'; return; }
        const year = document.getElementById('yearSelect').value;
        const data = Array.from({ length: 12 }, (_, i) => {
            const key = `${year}-${String(i + 1).padStart(2, '0')}`;
            return { month: MONTHS_FR[i], value: mois.find(m => m.mois === key)?.montant || 0 };
        });
        const maxV = Math.max(...data.map(d => d.value), 1);
        container.innerHTML = `
            <div class="flex items-end justify-between gap-1 h-full px-1" style="min-height:130px">
                ${data.map(d => {
                    const h = (d.value / maxV * 110);
                    return `<div class="flex-1 flex flex-col items-center justify-end gap-0.5 h-full">
                        ${d.value > 0 ? `<span class="text-[7px] font-bold text-slate-400">${EUR0(d.value)}</span>` : ''}
                        <div class="flex items-end gap-px w-full justify-center" style="height:120px">
                            <div class="bg-orange-400 rounded-t w-2/3" style="height:${h}px"></div>
                        </div>
                        <span class="text-[8px] font-bold text-slate-400">${d.month}</span>
                    </div>`;
                }).join('')}
            </div>`;
    }

    function showBankFeesDetail() {
        // Open the detail modal with all bank fee account prefixes
        const bankAccounts = '627,661,665,666,668';
        detailState.code = bankAccounts;
        detailState.label = 'Frais bancaires';
        detailState.page = 1;
        detailState.search = '';
        detailState.sousCompte = '';
        detailState.sort = 'montant';
        detailState.order = 'desc';
        counterpartState = { page: 1, search: '' };
        document.getElementById('detailTitle').innerHTML = '<i class="fas fa-university mr-1.5 text-orange-500"></i>Détail : Frais Bancaires';
        document.getElementById('detailSubtitle').textContent = `Comptes 627, 661, 665, 666, 668 · Exercice ${document.getElementById('yearSelect').value}`;
        document.getElementById('detailSearch').value = '';
        document.getElementById('detailSort').value = 'montant-desc';
        document.getElementById('detailSousCompte').innerHTML = '<option value="">Tous sous-comptes</option>';
        document.getElementById('counterpartSection').classList.add('hidden');
        document.getElementById('counterpartSearch').value = '';
        document.getElementById('detailLoading').classList.remove('hidden');
        document.getElementById('detailContent').classList.add('hidden');
        document.getElementById('detailModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        loadBankFeesDetail(true);
    }

    async function loadBankFeesDetail(loadSousComptes = false) {
        const year = document.getElementById('yearSelect').value;
        const compteFilter = detailState.sousCompte || detailState.code;
        const params = new URLSearchParams({
            exercice: year, page: detailState.page, per_page: 200,
            compte: compteFilter, sort: detailState.sort, order: detailState.order, any_class: 1
        });
        if (detailState.search) params.set('search', detailState.search);
        try {
            const resp = await fetch(`${API}/expenses/lines.php?${params}`);
            const json = await resp.json();
            if (!json.success) throw new Error(json.error);
            if (loadSousComptes && json.data.filters?.account_prefixes) {
                const sel = document.getElementById('detailSousCompte');
                sel.innerHTML = '<option value="">Tous sous-comptes</option>';
                // Fetch all sub-accounts
                const allParams = new URLSearchParams({ exercice: year, per_page: 1, compte: detailState.code, any_class: 1 });
                const allResp = await fetch(`${API}/expenses/lines.php?${allParams}`);
                const allJson = await allResp.json();
                if (allJson.success && allJson.data.filters?.account_prefixes) {
                    allJson.data.filters.account_prefixes.forEach(a => {
                        sel.add(new Option(`${a.prefix} — ${a.label?.substring(0,30) || ''} (${a.nb})`, a.prefix));
                    });
                }
            }
            renderDetailModal(json.data, json.data.source || 'ecritures');
            document.getElementById('counterpartSection').classList.add('hidden');
        } catch (e) {
            document.getElementById('detailLoading').classList.add('hidden');
            document.getElementById('detailContent').classList.remove('hidden');
            document.getElementById('detailContent').innerHTML = `<div class="text-center py-8 text-red-500 font-bold">${e.message}</div>`;
        }
    }

    // ── Boot ──
    init().catch(e => { document.getElementById('loading').innerHTML = `<p class="text-red-500 text-sm font-bold">Erreur: ${e.message}</p>`; });
    </script>
</body>
</html>
